#!/usr/bin/env python3
"""Tests clang-format, clang-tidy, and oclint against .c and .cpp
With this snippet:

    int main() {  int i;  return 10;}

- Triggers clang-format because what should be on 4 lines is on 1
- Triggers clang-tidy because "magical number" 10 is used
- Triggers oclint because short variable name is used
"""
import os
import subprocess as sp

import pytest

from hooks.clang_format import ClangFormatCmd
from hooks.clang_tidy import ClangTidyCmd
from hooks.oclint import OCLintCmd


class TestHooks:
    """Test all C Linters: clang-format, clang-tidy, and oclint."""
    @classmethod
    def setup_class(cls):
        """Create test files that will be used by other tests.

        "err" files are expected to error for all linters
        "ok" files are expected to pass for all listers
        """
        pwd = os.getcwd()
        cls.err_c = os.path.join(pwd, "tests/files/err.c")
        cls.err_cpp = os.path.join(pwd, "tests/files/err.cpp")
        cls.ok_c = os.path.join(pwd, "tests/files/ok.c")
        cls.ok_cpp = os.path.join(pwd, "tests/files/ok.cpp")

    @pytest.fixture(scope="function", params=[])
    def run_table_tests(self, cmd, args, tests):
        """Test each command's class from its python file
        and the command for each generated by setup.py.

        tests are in a table format and so are run in a loop."""
        name = cmd.command
        for t in tests:
            [filename, exp_output, exp_retcode] = t
            print("With", name, "class, testing file", filename)
            self.run_cmd_class(cmd, args, filename, exp_output, exp_retcode)
            print("With", name + "-hook command, testing file", filename)
            self.run_shell_cmd(cmd, args, filename, exp_output, exp_retcode)

    def test_clang_format(self):
        ok_str = ""
        err_str = """\n<  int main() { int i; return 10; }\n---\n>  int main() {\n>    int i;\n>    return 10;\n>  }\n"""  # noqa: E501
        cf_tests = [
            [self.ok_c, ok_str, 0],
            [self.ok_cpp, ok_str, 0],
            [self.err_c, err_str, 1],
            [self.err_cpp, err_str, 1],
        ]

        self.run_table_tests(ClangFormatCmd, [], cf_tests)

    def test_clang_tidy(self):
        ok_str = ""
        err_str = """{}:1:28: error: 10 is a magic number; consider replacing it with a named constant [cppcoreguidelines-avoid-magic-numbers,-warnings-as-errors]\nint main() {{ int i; return 10; }}\n                           ^\n"""  # noqa: E501
        err_str_c = err_str.format(self.err_c)
        err_str_cpp = err_str.format(self.err_cpp)
        ct_tests = [
            [self.ok_c, ok_str, 0],
            [self.ok_cpp, ok_str, 0],
            [self.err_c, err_str_c, 1],
            [self.err_cpp, err_str_cpp, 1],
        ]

        args = ["-quiet", "-checks=*", "-warnings-as-errors=*"]
        self.run_table_tests(ClangTidyCmd, args, ct_tests)

    #@pytest.mark.slow
    def test_oclint_err(self):
        ok_str = ""
        err_str = """Problem with oclint: OCLint Violations found\n\n\nOCLint Report\n\nSummary: TotalFiles=1 FilesWithViolations=1 P1=0 P2=0 P3=2 \n
{0}:1:14: short variable name [naming|P3] Length of variable name `i` is 1, which is shorter than the threshold of 3
{0}:1:14: unused local variable [unused|P3] The local variable 'i' is unused.\n\n[OCLint (http://oclint.org) v0.13]\n\n"""  # noqa: E501
        err_str_c = err_str.format(self.err_c)
        err_str_cpp = err_str.format(self.err_cpp)
        ocl_tests = [
            [self.ok_c, ok_str, 0],
            [self.ok_cpp, ok_str, 0],
            [self.err_c, err_str_c, 1],
            [self.err_cpp, err_str_cpp, 1],
        ]

        args = ["-enable-global-analysis", "-enable-clang-static-analyzer"]
        self.run_table_tests(OCLintCmd, args, ocl_tests)

    @staticmethod
    def run_cmd_class(cmd_class, args, fname, target_output, target_retcode):
        """Test the command class in each python hook file"""
        cmd = cmd_class([fname] + args)
        if target_retcode == 0:
            cmd.run()
        else:
            with pytest.raises(SystemExit):
                cmd.run()
        actual = cmd.stdout + cmd.stderr
        retcode = cmd.returncode
        assert actual == target_output
        assert retcode == target_retcode

    @staticmethod
    def run_shell_cmd(cmd_class, args, fname, target_output, target_retcode):
        """Use command generated by setup.py and installed by pip
        Ex. oclint => oclint-hook for the hook command"""
        all_args = [cmd_class.command + "-hook", fname, *args]
        sp_child = sp.run(all_args, stdout=sp.PIPE, stderr=sp.PIPE)
        actual = str(sp_child.stdout + sp_child.stderr, encoding='utf-8')
        retcode = sp_child.returncode
        assert actual == target_output
        assert retcode == target_retcode

